---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";

const mailinglists = await getCollection("mailinglists");
const sortedMailinglists = mailinglists
    .filter((mail) => !mail.data.draft)
    .sort(
        (a, b) =>
            new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
    )
    .slice(0, 10);

let mdEvents: Awaited<ReturnType<typeof getCollection<"mdEvents">>> = [];
try {
    mdEvents = await getCollection("mdEvents");
} catch {
    // Collection may not be available yet during initial sync
}

let apiEvents: Awaited<ReturnType<typeof getCollection<"events">>> = [];
try {
    apiEvents = await getCollection("events");
} catch {
    // Collection may not be available yet during initial sync
}

const allEvents = [
    ...mdEvents.map((m) => m.data),
    ...apiEvents.flatMap((p) => p.data.events),
];

const now = new Date();
const currentMonth = now.getMonth();
const currentYear = now.getFullYear();

const sortedEvents = allEvents.sort(
    (a, b) => new Date(a.time).getTime() - new Date(b.time).getTime(),
);

const meetupsCollection = await getCollection("meetups");
const meetups = meetupsCollection
    .map((m) => m.data)
    .sort((a, b) => a.label.localeCompare(b.label));
---

<Layout>
    <div
        class="via-white to-pink-100 min-h-screen flex items-center justify-center p-4"
    >
        <div class="w-full max-w-4xl">
            <!-- Header -->
            <div class="text-center mb-8">
                <img
                    src="/logo.jpeg"
                    alt="Logo Meetup Lille"
                    class="w-24 h-24 mx-auto rounded-full border-4 border-white shadow-md"
                />
                <h1 class="mt-4 text-2xl font-bold text-gray-800">
                    Meetup Lille Communities
                </h1>
                <p class="text-gray-500 text-sm mt-1">
                    Les communautés tech de la métropole lilloise
                </p>
            </div>

            <!-- Contenu en deux colonnes -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Colonne Meetups -->
                <section
                    class="bg-white rounded-2xl shadow-xl p-6"
                    aria-labelledby="communities-heading"
                >
                    <h2
                        id="communities-heading"
                        class="text-xl font-bold text-gray-800 mb-4 text-center"
                    >
                        Communautés
                    </h2>
                    <nav aria-label="Liste des communautés tech">
                        <ul class="space-y-4" role="list">
                            {
                                meetups.map((meetup) => (
                                    <li>
                                        <a
                                            href={meetup.href}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            aria-label={`Visiter la page de ${meetup.label} (nouvelle fenêtre)`}
                                            class="block w-full text-center px-4 py-3 rounded-lg bg-gray-600 text-white font-medium hover:bg-gray-700 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
                                        >
                                            {meetup.label}
                                        </a>
                                    </li>
                                ))
                            }
                        </ul>
                    </nav>
                </section>

                <!-- Colonne Événements du mois -->
                <section
                    class="bg-white rounded-2xl shadow-xl p-6"
                    aria-labelledby="events-heading"
                    id="events-section"
                >
                    <div class="flex items-center justify-between mb-4">
                        <button
                            id="prev-month"
                            type="button"
                            aria-label="Mois précédent"
                            class="p-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5"
                                viewBox="0 0 20 20"
                                fill="currentColor"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                                    clip-rule="evenodd"></path>
                            </svg>
                        </button>
                        <h2
                            id="events-heading"
                            class="text-xl font-bold text-gray-800 text-center"
                        >
                            Événements de <span id="current-month-label"
                                >{
                                    now.toLocaleDateString("fr-FR", {
                                        month: "long",
                                        year: "numeric",
                                    })
                                }</span
                            >
                        </h2>
                        <button
                            id="next-month"
                            type="button"
                            aria-label="Mois suivant"
                            class="p-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5"
                                viewBox="0 0 20 20"
                                fill="currentColor"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                    clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                    <ul
                        class="space-y-3"
                        role="list"
                        aria-label="Événements du mois"
                        id="events-list"
                    >
                    </ul>
                    <p
                        id="no-events-message"
                        class="text-gray-500 text-center hidden"
                    >
                        Aucun événement ce mois-ci
                    </p>
                </section>
                <script
                    define:vars={{ sortedEvents, currentMonth, currentYear }}
                >
                    const events = sortedEvents;
                    let displayMonth = currentMonth;
                    let displayYear = currentYear;
                    const minMonth = currentMonth;
                    const minYear = currentYear;

                    function formatDate(dateStr) {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString("fr-FR", {
                            weekday: "long",
                            day: "numeric",
                            month: "long",
                            hour: "2-digit",
                            minute: "2-digit",
                        });
                    }

                    function formatMonthLabel(month, year) {
                        const date = new Date(year, month, 1);
                        return date.toLocaleDateString("fr-FR", {
                            month: "long",
                            year: "numeric",
                        });
                    }

                    function renderEvents() {
                        const filteredEvents = events.filter((event) => {
                            const eventDate = new Date(event.time);
                            return (
                                eventDate.getMonth() === displayMonth &&
                                eventDate.getFullYear() === displayYear
                            );
                        });

                        const eventsList =
                            document.getElementById("events-list");
                        const noEventsMessage =
                            document.getElementById("no-events-message");
                        const monthLabel = document.getElementById(
                            "current-month-label",
                        );
                        const prevButton =
                            document.getElementById("prev-month");

                        monthLabel.textContent = formatMonthLabel(
                            displayMonth,
                            displayYear,
                        );

                        // Disable prev button if at minimum month
                        const isAtMinMonth =
                            displayMonth === minMonth &&
                            displayYear === minYear;
                        prevButton.disabled = isAtMinMonth;

                        if (filteredEvents.length === 0) {
                            eventsList.innerHTML = "";
                            noEventsMessage.classList.remove("hidden");
                        } else {
                            noEventsMessage.classList.add("hidden");
                            eventsList.innerHTML = filteredEvents
                                .map(
                                    (event) => `
                                <li>
                                    <a
                                        href="${event.link}"
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        class="block p-4 rounded-lg bg-gray-50 hover:bg-gray-100 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
                                        aria-label="Voir l'événement : ${event.title} (nouvelle fenêtre)"
                                    >
                                        <div class="flex items-center justify-between">
                                            <time
                                                class="text-sm text-gray-500"
                                                datetime="${new Date(event.time).toISOString()}"
                                            >
                                                ${formatDate(event.time)}
                                            </time>
                                            ${
                                                event.meetup
                                                    ? `
                                                <span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded">
                                                    ${event.meetup}
                                                </span>
                                            `
                                                    : ""
                                            }
                                        </div>
                                        <div class="font-medium text-gray-800 mt-1">
                                            ${event.title}
                                        </div>
                                        ${
                                            event.speaker
                                                ? `
                                            <div class="text-sm text-gray-600 mt-1">
                                                Par ${event.speaker}
                                            </div>
                                        `
                                                : ""
                                        }
                                    </a>
                                </li>
                            `,
                                )
                                .join("");
                        }
                    }

                    document
                        .getElementById("prev-month")
                        .addEventListener("click", () => {
                            // Check if we can go back
                            if (
                                displayMonth === minMonth &&
                                displayYear === minYear
                            ) {
                                return;
                            }
                            if (displayMonth === 0) {
                                displayMonth = 11;
                                displayYear--;
                            } else {
                                displayMonth--;
                            }
                            renderEvents();
                        });

                    document
                        .getElementById("next-month")
                        .addEventListener("click", () => {
                            if (displayMonth === 11) {
                                displayMonth = 0;
                                displayYear++;
                            } else {
                                displayMonth++;
                            }
                            renderEvents();
                        });

                    // Initial render
                    renderEvents();
                </script>
            </div>

            <!-- Section Mailing List -->
            <section
                class="bg-white rounded-2xl shadow-xl p-6 mt-6"
                aria-labelledby="mailinglist-heading"
            >
                <h2
                    id="mailinglist-heading"
                    class="text-xl font-bold text-gray-800 mb-4 text-center"
                >
                    Mailing List
                </h2>
                {
                    sortedMailinglists.length > 0 ? (
                        <ul
                            class="space-y-3 text-left"
                            role="list"
                            aria-label="Dernières mailing lists"
                        >
                            {sortedMailinglists.map((mail) => (
                                <li>
                                    <a
                                        href={`/mailinglists/${mail.id}`}
                                        class="block p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
                                        aria-label={`Lire la mailing list : ${mail.data.title}`}
                                    >
                                        <time
                                            class="text-sm text-gray-500"
                                            datetime={new Date(
                                                mail.data.date,
                                            ).toISOString()}
                                        >
                                            {new Date(
                                                mail.data.date,
                                            ).toLocaleDateString("fr-FR", {
                                                day: "numeric",
                                                month: "long",
                                                year: "numeric",
                                            })}
                                        </time>
                                        <div class="font-medium text-gray-800">
                                            {mail.data.title}
                                        </div>
                                        {mail.data.description && (
                                            <p class="text-sm text-gray-600 mt-1">
                                                {mail.data.description}
                                            </p>
                                        )}
                                    </a>
                                </li>
                            ))}
                        </ul>
                    ) : (
                        <p class="text-gray-500 text-center">
                            Aucune mailing list pour le moment
                        </p>
                    )
                }
                <a
                    href="/mailinglists"
                    class="inline-block mt-4 text-gray-600 hover:text-gray-800 font-medium transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
                    aria-label="Voir toutes les mailing lists"
                >
                    Voir toutes les mailing lists{" "}
                    <span aria-hidden="true">&rarr;</span>
                </a>
            </section>
        </div>
    </div>
</Layout>
