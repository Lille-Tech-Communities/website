---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import MeetupsList from "../components/MeetupsList.astro";
import EventsSection from "../components/EventsSection.astro";
import MailingListSection from "../components/MailingListSection.astro";
import { getCollection } from "astro:content";

const mailinglists = await getCollection("mailinglists");
const sortedMailinglists = mailinglists
    .filter((mail) => !mail.data.draft)
    .sort(
        (a, b) =>
            new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
    )
    .slice(0, 10);

let mdEvents: Awaited<ReturnType<typeof getCollection<"mdEvents">>> = [];
try {
    mdEvents = await getCollection("mdEvents");
} catch {
    // Collection may not be available yet during initial sync
}

let apiEvents: Awaited<ReturnType<typeof getCollection<"events">>> = [];
try {
    apiEvents = await getCollection("events");
} catch {
    // Collection may not be available yet during initial sync
}

const allEvents = [
    ...mdEvents.map((m) => m.data),
    ...apiEvents.flatMap((p) => p.data.events),
];

const now = new Date();
const currentMonth = now.getMonth();
const currentYear = now.getFullYear();

const sortedEvents = allEvents.sort(
    (a, b) => new Date(a.time).getTime() - new Date(b.time).getTime(),
);

const meetupsCollection = await getCollection("meetups");
const meetups = meetupsCollection
    .map((m) => m.data)
    .sort((a, b) => a.label.localeCompare(b.label));
---

<Layout>
    <div
        class="via-white to-pink-100 min-h-screen flex items-center justify-center p-4"
    >
        <div class="w-full max-w-4xl">
            <Header />

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <MeetupsList meetups={meetups} />
                <EventsSection
                    events={sortedEvents}
                    currentMonth={currentMonth}
                    currentYear={currentYear}
                />
            </div>

            <MailingListSection mailinglists={sortedMailinglists} />
        </div>
    </div>
</Layout>
